"use strict";tinymce.PluginManager.add("abbreviations",function(e,t){function n(e,t){var n=e.dom,r=e.dom.doc;if(null===l)return null;var i=t.data.split(l);if(1===i.length)return null;for(var s=r.createDocumentFragment();i.length;){var c=i.shift(),u=null;i.length&&(u=i.shift()),s.appendChild(r.createTextNode(c)),u&&(o[u]?n.getParent(t,"acronym")?s.appendChild(r.createTextNode(u)):n.add(s,"abbr",{name:u.replace(/\s+/,"_"),title:a[u]},u):a[u]&&(n.getParent(t,"abbr")?s.appendChild(r.createTextNode(u)):n.add(s,"abbr",{name:u.replace(/\s+/,"_"),title:a[u]},u)))}return s}function r(){var t=e.dom;if(i){for(var n=t.$("abbr",i.getEl()),r=0,o=0;o<n.length;o++)r<n[o].offsetWidth&&(r=n[o].offsetWidth);r>0&&n.css("width",r+"px")}}var i,o,a,s={},l=null,c={name:"abbreviations",processTextNode:n};tinymce.DOM.styleSheetLoader.load(t+"/css/abbrpanel.css"),e.on("init",function(){e.settings.abbrpanel_show_on_start&&e.execCommand("mceShowAbbrPanel")}),e.fire("mceInlineRegister",c),e.on("mceInlineSetContent",function(){var t,n=e.dom;e.dom.doc;o={},a={},t=n.select("acronym[title]");for(var r=0,i=t.length;r<i;r++)t[r].title&&(o[t[r].textContent.trim()]=t[r].title.trim(),a[t[r].textContent.trim()]=t[r].title.trim());t=n.select("abbr[title]");for(var r=0,i=t.length;r<i;r++)t[r].title&&(a[t[r].textContent.trim()]=t[r].title.trim());var s=n.select("#abbreviations")[0];if(s){t=n.select("p,li",s);for(var r=0,i=t.length;r<i;r++){var c,u,d=t[r].textContent;c=d.indexOf("\xa0"),c==-1&&(c=d.search(/\s/)),c>0&&(u=d.substring(c).trim(),c=d.substring(0,c),a[c]=u)}n.$(s).remove()}var t=Object.keys(a);t.length?(l="((?:\\b"+t.join("\\b)|(?:\\b")+"\\b))",l=new RegExp(l)):l=null});var u=function(t,n){function r(e){i.$("style#abbr-highlight").remove(),e&&e.length&&i.$("head").append('<style id="abbr-highlight">abbr[name="'+e+'"]{background-color:yellow;}</style>')}var i=e.dom,o=i.doc.createElement("li");i.add(o,"abbr",{title:n},t);return o.appendChild(i.doc.createTextNode(n)),o.addEventListener("dblclick",function(t){var n=this,r=i.$("abbr",n)[0],o=r.textContent.trim(),a=r.title,l=function(e){r.title=e,n.removeChild(r.nextSibling),n.appendChild(i.doc.createTextNode(e));var t=s[o];if(t){for(var a=0,l=t.length;a<l;a++)if(!(t[a]<e)){t[a]>e&&t.splice(a,0,e);break}a==l&&t.push(e)}else t=s[o]=[e];i.$('abbr[name="'+o.replace(/\s+/,"_")+'"]').attr("title",e)},c=function(t,n,r,i){var o=[];if(r&&r.length)for(var a=0,s=r.length;a<s;a++)o.push({text:r[a],value:r[a]});var c=e.windowManager.open({layout:"flex",pack:"center",align:"center",onClose:function(){e.focus()},onSubmit:function(){e.focus();var t=c.find("#abbr");t.length&&l(t[0].value())},title:"Abbreviation: "+t,width:600,items:{type:"form",padding:20,labelGap:20,spacing:4,items:[{type:"combobox",name:"abbr",label:t,value:n,menu:o}]}})},u=function(e,t){t(["Abbreviation meaning 1","Abbreviation meaning 2"])},d=s[o];d?c(o,a,d):u(o,function(e){s[o]=e,c(o,a,e)})}),o.addEventListener("click",function(t){r(i.$("abbr",this)[0].textContent.trim().replace(/\s+/,"_")),i.$("li.current",this.parentNode).removeClass("current"),this.classList.add("current"),e.focus()}),o};return e.addCommand("mceShowAbbrPanel",function(){var t=e.dom;if(i)e.fire("DeleteSidePanel",{item:i}),i=null;else{i=tinymce.ui.Factory.create({type:"control",name:"abbr-panel",classes:"abbr-panel",title:"Abbreviations"}),e.fire("AddSidePanel",{item:i,side:"left"});var n=t.doc.createElement("ul"),o=Object.keys(a).sort();tinymce.each(o,function(e){var t=a[e],r=u(e,t);n.appendChild(r)}),i.getEl().appendChild(n)}e.focus(),e.fire("AbbrPanelStateChanged",{state:!!i}),r()}),e.addMenuItem("abbrPanel",{text:"Abbreviations",selectable:!0,cmd:"mceShowAbbrPanel",onPostRender:function(){var t=this;t.active(!!i),e.on("AbbrPanelStateChanged",function(e){t.active(e.state)})},context:"view"}),e.addButton("abbreviation",{title:"Abbreviation",icon:"forecolor",cmd:"mceMakeAbbreviation"}),e.addCommand("mceMakeAbbreviation",function(){var t=e.dom,n=(e.dom.doc,e.selection.getRng());if(n.startContainer==n.endContainer&&"ABBR"!=n.startContainer.parentNode.tagName){var o=n.startContainer.textContent,s=o.substring(n.startOffset,n.endOffset).replace(/^\s+/,""),l=n.endOffset-s.length;s=s.trim();var c=l+s.length,d=t.createFragment(o.substring(0,l)+'<abbr title="" name="'+s.replace(/\s+/,"_")+'">'+s+"</abbr>"+o.substr(c));if(n.startContainer.parentNode.replaceChild(d,n.startContainer),a[s]="",i){var f,p=u(s,""),m=i.$("abbr",i.getEl());for(f=0;f<m.length;f++){var g=m[f].textContent.trim();if(s.toLowerCase()<g.toLowerCase())break}if(f<m.length){var h=m[f].parentNode;h.parentNode.insertBefore(p,h)}else{var v=i.$("ul",i.getEl())[0];v.appendChild(p)}r()}}}),{}},["inlines","sidepanel"]);