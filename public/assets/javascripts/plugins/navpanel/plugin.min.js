"use strict";var isHeaderNode=function(e){return["h1","h2","h3","h4","h5","h6"].indexOf(e.nodeName.toLowerCase())>=0},subHeaderNode=function(e){for(var t=e.lastChild;t;t=t.previousSibling){var n=subHeaderNode(t);if(n)return n;if(isHeaderNode(t))return t}return null},previousHeaderNode=function(e){for(var t=e.previousSibling;t;){var n=subHeaderNode(t);if(n)return n;if(isHeaderNode(t))return t;t=t.previousSibling}if(e.parentNode&&"body"!=e.parentNode.nodeName.toLowerCase()){if(isHeaderNode(e.parentNode))return e.parentNode;t=previousHeaderNode(e.parentNode)}return null},NavTree=function(e,t){var n=document.createElement("ul"),r=null,i=function(e,t){if(n)for(var r=n.firstChild;r;r=r.nextSibling)if(r.nodeType==Node.ELEMENT_NODE&&e(r,t))return r;return null},o=function(e){return i(function(t){return t.id==e?t:null})},a=this.tocItemByElement=function(e){return"string"==typeof e?o("toc-"+e):e.id&&e.id.startsWith("hdr-")?o("toc-"+e.id):null},s=this.elementByTocItem=function(e){return t.dom.get(e.id.substr(4))};this.onHeaderElementSelected=function(e){var t=this.tocItemByElement(e);t&&l(t)};var l=this.selectTocItem=function(e){r&&r.classList.remove("current"),e.classList.add("current"),r=e},c=function(e){var r=e.target;if(r){var i=s(r);i?(i.scrollIntoView(),t.selection.setCursorLocation(i,0),t.focus()):n.removeChild(r),l(r)}},u=function(e){var t;return e.id&&e.id.startsWith("hdr-")||(e.id="hdr-"+Math.random().toString(36).substring(2,15)),t=o(e.id),t||(t=document.createElement("li"),t.id="toc-"+e.id,t.className="toc-"+e.nodeName.toLowerCase(),t.level=parseInt(e.nodeName.substr(1),10),t.addEventListener("click",c)),t.textContent=e.textContent,t};this.setContent=function(e){var t,r,i=e.select("h1,h2,h3,h4,h5,h6"),o=document.createElement("ul");for(t=0,r=i.length;t<r;t++){var a=i[t],s=u(a);s.parentNode&&(s=s.parentNode.removeChild(s)),o.appendChild(s)}return this.toc=n=o,o},this.updateTocItem=function(e,t){e.className=e.className.replace(/toc-h\w*\s*/i,"")+" toc-"+t.nodeName.toLowerCase(),e.level=parseInt(t.nodeName.substr(1),10),e.textContent=t.textContent},this.insertTocItemForElement=function(e){var t=u(e);if(!t.parentNode){var r=previousHeaderNode(e);r&&(r=a(r)),r=r?r.nextSibling:n.firstChild,t=r?n.insertBefore(t,r):n.appendChild(t)}},this.removeTocItem=function(e){var t=s(e);t&&t.id&&t.id.startsWith("hdr-")&&(t.id=void 0),n.removeChild(e)};var d=!1,f={},p=function(e){d=!1;for(var r in f){var i,o=t.dom.get(r);if(o){if(i=e.tocItemByElement(o))for(e.updateTocItem(i,o),i=i.nextSibling;i&&!(o=s(i));){var a=i.nextSibling;n.removeChild(i),i=a}}else i=e.tocItemById("toc-"+r),i&&n.removeChild(i)}f={}};this.setupTocUpdate=function(e){e.id&&e.id.startsWith("hdr-")&&(d&&(clearTimeout(d),d=!1),f[e.id]=!0,d=setTimeout(p,200,this))}};tinymce.PluginManager.add("navpanel",function(e,t){var n,r;return tinymce.DOM.styleSheetLoader.load(t+"/css/navpanel.css"),n=new NavTree(tinymce,e),e.on("init",function(){e.settings.navpanel_show_on_start&&e.execCommand("mceShowNavPanel")}),e.on("SetContent",function(){var t=n.toc;if(n.setContent(e.dom),r){var i=r.getEl();i&&(i.removeChild(t),i.appendChild(n.toc))}}),e.on("nodeChange",function(e){if(e.selectionChange){var t,r=e.element;isHeaderNode(r)?(t=n.tocItemByElement(r),t?n.updateTocItem(t,r):t=n.insertTocItemForElement(r)):(t=n.tocItemByElement(r),t&&n.removeTocItem(t),r=previousHeaderNode(r)),r&&n.onHeaderElementSelected(r)}}),e.on("selectionchange",function(){var t=e.dom.getParent(e.selection.getNode(),isHeaderNode);t&&n.setupTocUpdate(t)}),e.on("keyup",function(t){if(46==t.keyCode&&!t.ctrlKey&&!t.shiftKey&&!t.altKey){var r=e.dom.getParent(e.selection.getNode(),isHeaderNode);r&&n.setupTocUpdate(r)}}),e.addCommand("mceShowNavPanel",function(){r?(e.fire("DeleteSidePanel",{item:r}),r=null):(r=tinymce.ui.Factory.create({type:"control",name:"nav-panel",classes:"nav-panel",title:"Table of Contents"}),e.fire("AddSidePanel",{item:r,side:"left"}),r.getEl().appendChild(n.toc)),e.focus(),e.fire("NavPanelStateChanged",{state:!!r})}),e.addMenuItem("navPanel",{text:"Navigation pane",selectable:!0,cmd:"mceShowNavPanel",onPostRender:function(){var t=this;t.active(!!r),e.on("NavPanelStateChanged",function(e){t.active(e.state)})},context:"view"}),{}},["sidepanel"]);